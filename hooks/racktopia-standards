#!/bin/bash
set -euo pipefail

# Racktopia Standards Hook
# Verifies that .pre-commit-config.yaml includes the appropriate hooks
# based on the types of files present in the repository.

# Configuration: Freshness limits for racktopia/.github hooks
# Hooks pass if they are within EITHER limit (not both required)
MAX_COMMITS_BEHIND=10    # Maximum commits behind latest before requiring update
MAX_DAYS_OLD=7           # Maximum days old before requiring update
WARNING_COMMIT_THRESHOLD=5   # Warn when more than this many commits behind (50% of MAX_COMMITS_BEHIND)
WARNING_DAY_THRESHOLD=3      # Warn when older than this many days (roughly 50% of MAX_DAYS_OLD)

CONFIG_FILE=".pre-commit-config.yaml"
EXIT_CODE=0

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

echo "ðŸ” Checking racktopia standards compliance..."

# Check if .pre-commit-config.yaml exists
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo -e "${RED}âŒ Missing .pre-commit-config.yaml file${NC}"
    echo "   Please create a .pre-commit-config.yaml file with racktopia/.github hooks"
    EXIT_CODE=1
fi

# Function to check if a hook is enabled in pre-commit config
check_hook_enabled() {
    local hook_name="$1"
    if [[ -f "$CONFIG_FILE" ]] && grep -q "id: $hook_name" "$CONFIG_FILE"; then
        return 0
    else
        return 1
    fi
}

# Function to check for files matching patterns
has_files() {
    local pattern="$1"
    # Use find to check for files matching the pattern
    if find . -name "$pattern" -type f -print -quit | grep -q .; then
        return 0
    else
        return 1
    fi
}

# Function to check for files in specific directories
has_files_in_dir() {
    local dir="$1"
    local pattern="$2"
    if [[ -d "$dir" ]] && find "$dir" -name "$pattern" -type f -print -quit | grep -q .; then
        return 0
    else
        return 1
    fi
}

# Check for markdown files
if has_files "*.md"; then
    if check_hook_enabled "markdownlint"; then
        echo -e "${GREEN}âœ… Markdown files found - markdownlint hook is enabled${NC}"
    else
        echo -e "${RED}âŒ Markdown files found but markdownlint hook is missing${NC}"
        echo "   Add 'id: markdownlint' to your .pre-commit-config.yaml"
        EXIT_CODE=1
    fi
else
    echo -e "${YELLOW}â„¹ï¸  No markdown files found${NC}"
fi

# Check for YAML files
if has_files "*.yml" || has_files "*.yaml"; then
    if check_hook_enabled "yamllint"; then
        echo -e "${GREEN}âœ… YAML files found - yamllint hook is enabled${NC}"
    else
        echo -e "${RED}âŒ YAML files found but yamllint hook is missing${NC}"
        echo "   Add 'id: yamllint' to your .pre-commit-config.yaml"
        EXIT_CODE=1
    fi
else
    echo -e "${YELLOW}â„¹ï¸  No YAML files found${NC}"
fi

# Check for Ansible files
if has_files_in_dir "ansible" "*.yml" || has_files_in_dir "ansible" "*.yaml" || \
   has_files "playbook*.yml" || has_files "playbook*.yaml" || \
   has_files "site.yml" || has_files "site.yaml" || \
   has_files "*playbook*.yml" || has_files "*playbook*.yaml"; then
    
    if check_hook_enabled "ansible-lint"; then
        echo -e "${GREEN}âœ… Ansible files found - ansible-lint hook is enabled${NC}"
    else
        echo -e "${RED}âŒ Ansible files found but ansible-lint hook is missing${NC}"
        echo "   Add 'id: ansible-lint' to your .pre-commit-config.yaml"
        EXIT_CODE=1
    fi
    
    if check_hook_enabled "ansible-syntax-check"; then
        echo -e "${GREEN}âœ… Ansible files found - ansible-syntax-check hook is enabled${NC}"
    else
        echo -e "${RED}âŒ Ansible files found but ansible-syntax-check hook is missing${NC}"
        echo "   Add 'id: ansible-syntax-check' to your .pre-commit-config.yaml"
        EXIT_CODE=1
    fi
else
    echo -e "${YELLOW}â„¹ï¸  No Ansible files found${NC}"
fi

# Check for sensitive files that should have secrets detection
if has_files_in_dir "ansible" "*.yml" || has_files_in_dir "ansible" "*.yaml" || \
   has_files "*.env*" || has_files "*.secret*" || has_files_in_dir ".github" "*.yml"; then
    
    if check_hook_enabled "detect-secrets"; then
        echo -e "${GREEN}âœ… Sensitive files found - detect-secrets hook is enabled${NC}"
    else
        echo -e "${RED}âŒ Sensitive files found but detect-secrets hook is missing${NC}"
        echo "   Add 'id: detect-secrets' to your .pre-commit-config.yaml"
        EXIT_CODE=1
    fi
else
    echo -e "${YELLOW}â„¹ï¸  No sensitive files requiring secrets detection found${NC}"
fi

# Check that the racktopia/.github repo is being used
if [[ -f "$CONFIG_FILE" ]]; then
    if grep -q "repo: https://github.com/racktopia/.github" "$CONFIG_FILE"; then
        echo -e "${GREEN}âœ… Using racktopia/.github shared hooks${NC}"
        
        # Check if we're in the racktopia/.github repo itself or another repo
        is_github_repo=false
        hooks_outdated=false
        current_rev=""
        latest_commit=""
        current_display=""
        
        # Check remote URL with error handling
        if git remote get-url origin 2>/dev/null | grep -q "racktopia/\.github" 2>/dev/null; then
            is_github_repo=true
        fi
        
        # Parse current revision with error handling
        current_rev=$(grep -A 5 "repo: https://github.com/racktopia/.github" "$CONFIG_FILE" | grep "rev:" | awk '{print $2}' | head -1 2>/dev/null || echo "")
        
        if [[ -n "$current_rev" && "$current_rev" != "main" ]]; then
            # Get last N commit SHAs and dates from main branch
            recent_commits_data=$(curl -s -f "https://api.github.com/repos/racktopia/.github/commits?per_page=${MAX_COMMITS_BEHIND}" 2>/dev/null || echo "")
            recent_commits=$(echo "$recent_commits_data" | grep '"sha"' | head -${MAX_COMMITS_BEHIND} | cut -d'"' -f4 2>/dev/null || echo "")
            current_short=$(echo "$current_rev" | cut -c1-40)  # Full SHA for comparison
            
            if [[ -n "$recent_commits" ]]; then
                # Check if current revision is in last N commits
                within_commit_limit=false
                commit_position=0
                if echo "$recent_commits" | grep -q "$current_short"; then
                    within_commit_limit=true
                    commit_position=$(echo "$recent_commits" | grep -n "$current_short" | cut -d: -f1 | head -1)
                fi
                
                # Check if current revision is within configured day limit
                within_time_limit=false
                age_display=""
                current_commit_date=$(echo "$recent_commits_data" | grep -A 10 "\"sha\": \"$current_short\"" | grep '"date"' | head -1 | cut -d'"' -f4 2>/dev/null || echo "")
                if [[ -n "$current_commit_date" ]]; then
                    # Convert dates to epoch seconds for comparison
                    current_epoch=$(date -d "$current_commit_date" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$current_commit_date" +%s 2>/dev/null || echo "0")
                    days_ago_epoch=$(date -d "${MAX_DAYS_OLD} days ago" +%s 2>/dev/null || date -j -v-${MAX_DAYS_OLD}d +%s 2>/dev/null || echo "0")
                    now_epoch=$(date +%s)
                    
                    if [[ "$current_epoch" -gt "$days_ago_epoch" && "$current_epoch" -gt 0 ]]; then
                        within_time_limit=true
                        # Calculate age in days, hours, and minutes
                        age_seconds=$((now_epoch - current_epoch))
                        
                        # Handle negative age (future commits due to timezone differences)
                        if [[ "$age_seconds" -lt 0 ]]; then
                            age_display="0:00 old"
                            age_days=0
                        else
                            age_days=$((age_seconds / 86400))  # 86400 seconds in a day
                            age_hours=$(((age_seconds % 86400) / 3600))  # 3600 seconds in an hour
                            age_minutes=$(((age_seconds % 3600) / 60))   # 60 seconds in a minute
                            
                            # Format age display
                            if [[ "$age_days" -gt 0 ]]; then
                                printf -v age_display "%d days, %d:%02d old" "$age_days" "$age_hours" "$age_minutes"
                            else
                                printf -v age_display "%d:%02d old" "$age_hours" "$age_minutes"
                            fi
                        fi
                    fi
                fi
                
                # Pass if within either limit (commits OR time-based)
                if [[ "$within_commit_limit" == "true" || "$within_time_limit" == "true" ]]; then
                    latest_commit=$(echo "$recent_commits" | head -1 | cut -c1-7)
                    current_display=$(echo "$current_short" | cut -c1-7)
                    
                    # Build status message with progress info
                    status_parts=()
                    if [[ "$within_commit_limit" == "true" ]]; then
                        status_parts+=("${commit_position}/${MAX_COMMITS_BEHIND} commits behind")
                    fi
                    if [[ "$within_time_limit" == "true" ]]; then
                        status_parts+=("$age_display")
                    fi
                    progress_info=$(IFS=', '; echo "${status_parts[*]}")
                    
                    if [[ "$is_github_repo" == "true" ]]; then
                        if [[ "$within_commit_limit" == "true" ]]; then
                            echo -e "${GREEN}âœ… Current revision is within last ${MAX_COMMITS_BEHIND} commits ($progress_info)${NC}"
                        else
                            echo -e "${GREEN}âœ… Current revision is within last ${MAX_DAYS_OLD} days ($progress_info)${NC}"
                        fi
                    else
                        if [[ "$within_commit_limit" == "true" ]]; then
                            echo -e "${GREEN}âœ… racktopia/.github hooks are current ($current_display, $progress_info)${NC}"
                        else
                            echo -e "${GREEN}âœ… racktopia/.github hooks are recent ($current_display, $progress_info)${NC}"
                        fi
                    fi
                    
                    # Check if we're more than halfway to limits and warn
                    should_warn=false
                    if [[ "$within_commit_limit" == "true" && "$commit_position" -gt "$WARNING_COMMIT_THRESHOLD" ]]; then
                        should_warn=true
                    fi
                    if [[ "$within_time_limit" == "true" && "$age_days" -gt "$WARNING_DAY_THRESHOLD" ]]; then
                        should_warn=true
                    fi
                    
                    if [[ "$should_warn" == "true" ]]; then
                        echo -e "${YELLOW}âš ï¸  WARNING: Approaching update limits!${NC}"
                        echo -e "${YELLOW}   Consider running: pre-commit autoupdate${NC}"
                    fi
                else
                    hooks_outdated=true
                    latest_commit=$(echo "$recent_commits" | head -1 | cut -c1-7)
                    current_display=$(echo "$current_short" | cut -c1-7)
                fi
            else
                echo -e "${YELLOW}â„¹ï¸  Could not verify commit recency (network issue?)${NC}"
            fi
        elif [[ "$current_rev" == "main" ]]; then
            if [[ "$is_github_repo" == "true" ]]; then
                echo -e "${YELLOW}âš ï¸  Using branch reference 'main' instead of pinned commit${NC}"
                echo "   Consider pinning to specific commit to avoid pre-commit warnings"
            else
                echo -e "${YELLOW}â„¹ï¸  Using branch reference instead of commit hash${NC}"
            fi
        else
            echo -e "${RED}âŒ Could not determine current revision${NC}"
            EXIT_CODE=1
        fi
        
        # Handle outdated hooks with helpful commands
        if [[ "$hooks_outdated" == "true" ]]; then
            echo -e "${RED}âŒ racktopia/.github hooks are outdated (>${MAX_COMMITS_BEHIND} commits behind AND >${MAX_DAYS_OLD} days old)${NC}"
            echo "   Current rev: $current_display"
            echo "   Latest commit: $latest_commit"
            echo
            echo "   Show changes:   git log --oneline ${current_display}..${latest_commit} --no-merges"
            echo "   Show code diff: git diff ${current_display}..${latest_commit}"
            echo
            echo "   Run: pre-commit autoupdate"
            if [[ "$is_github_repo" == "false" ]]; then
                echo "   Then review changes and commit the updated .pre-commit-config.yaml"
            fi
            EXIT_CODE=1
        fi
    else
        echo -e "${RED}âŒ Not using racktopia/.github shared hooks${NC}"
        echo "   Update your .pre-commit-config.yaml to use 'repo: https://github.com/racktopia/.github'"
        EXIT_CODE=1
    fi
fi

# Summary
echo ""
if [[ $EXIT_CODE -eq 0 ]]; then
    echo -e "${GREEN}ðŸŽ‰ All racktopia standards checks passed!${NC}"
else
    echo -e "${RED}âŒ Some racktopia standards checks failed${NC}"
    echo ""
    echo "Example .pre-commit-config.yaml:"
    echo "---"
    echo "repos:"
    echo "  - repo: https://github.com/racktopia/.github"
    if git remote get-url origin 2>/dev/null | grep -q "racktopia/\.github"; then
        echo "    rev: main              # Use 'main' for racktopia/.github repo itself"
    else
        echo "    rev: main              # Or use specific commit hash (updated via 'pre-commit autoupdate')"
    fi
    echo "    hooks:"
    echo "      - id: racktopia-standards   # Always include this first"
    echo "      # Keep remaining hooks in alphabetical order:"
    echo "      - id: ansible-lint          # if you have ansible/ directory"
    echo "      - id: ansible-syntax-check  # if you have ansible/ directory"
    echo "      - id: detect-secrets        # if you have sensitive config files"
    echo "      - id: markdownlint          # if you have .md files"
    echo "      - id: yamllint              # if you have .yml/.yaml files"
fi

exit $EXIT_CODE