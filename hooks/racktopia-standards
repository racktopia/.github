#!/bin/bash
set -euo pipefail

# Racktopia Standards Hook
# Verifies that .pre-commit-config.yaml includes the appropriate hooks
# based on the types of files present in the repository.

CONFIG_FILE=".pre-commit-config.yaml"
EXIT_CODE=0

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

echo "ðŸ” Checking racktopia standards compliance..."

# Check if .pre-commit-config.yaml exists
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo -e "${RED}âŒ Missing .pre-commit-config.yaml file${NC}"
    echo "   Please create a .pre-commit-config.yaml file with racktopia/.github hooks"
    EXIT_CODE=1
fi

# Function to check if a hook is enabled in pre-commit config
check_hook_enabled() {
    local hook_name="$1"
    if [[ -f "$CONFIG_FILE" ]] && grep -q "id: $hook_name" "$CONFIG_FILE"; then
        return 0
    else
        return 1
    fi
}

# Function to check for files matching patterns
has_files() {
    local pattern="$1"
    # Use find to check for files matching the pattern
    if find . -name "$pattern" -type f -print -quit | grep -q .; then
        return 0
    else
        return 1
    fi
}

# Function to check for files in specific directories
has_files_in_dir() {
    local dir="$1"
    local pattern="$2"
    if [[ -d "$dir" ]] && find "$dir" -name "$pattern" -type f -print -quit | grep -q .; then
        return 0
    else
        return 1
    fi
}

# Check for markdown files
if has_files "*.md"; then
    if check_hook_enabled "markdownlint"; then
        echo -e "${GREEN}âœ… Markdown files found - markdownlint hook is enabled${NC}"
    else
        echo -e "${RED}âŒ Markdown files found but markdownlint hook is missing${NC}"
        echo "   Add 'id: markdownlint' to your .pre-commit-config.yaml"
        EXIT_CODE=1
    fi
else
    echo -e "${YELLOW}â„¹ï¸  No markdown files found${NC}"
fi

# Check for YAML files
if has_files "*.yml" || has_files "*.yaml"; then
    if check_hook_enabled "yamllint"; then
        echo -e "${GREEN}âœ… YAML files found - yamllint hook is enabled${NC}"
    else
        echo -e "${RED}âŒ YAML files found but yamllint hook is missing${NC}"
        echo "   Add 'id: yamllint' to your .pre-commit-config.yaml"
        EXIT_CODE=1
    fi
else
    echo -e "${YELLOW}â„¹ï¸  No YAML files found${NC}"
fi

# Check for Ansible files
if has_files_in_dir "ansible" "*.yml" || has_files_in_dir "ansible" "*.yaml" || \
   has_files "playbook*.yml" || has_files "playbook*.yaml" || \
   has_files "site.yml" || has_files "site.yaml" || \
   has_files "*playbook*.yml" || has_files "*playbook*.yaml"; then
    
    if check_hook_enabled "ansible-lint"; then
        echo -e "${GREEN}âœ… Ansible files found - ansible-lint hook is enabled${NC}"
    else
        echo -e "${RED}âŒ Ansible files found but ansible-lint hook is missing${NC}"
        echo "   Add 'id: ansible-lint' to your .pre-commit-config.yaml"
        EXIT_CODE=1
    fi
    
    if check_hook_enabled "ansible-syntax-check"; then
        echo -e "${GREEN}âœ… Ansible files found - ansible-syntax-check hook is enabled${NC}"
    else
        echo -e "${RED}âŒ Ansible files found but ansible-syntax-check hook is missing${NC}"
        echo "   Add 'id: ansible-syntax-check' to your .pre-commit-config.yaml"
        EXIT_CODE=1
    fi
else
    echo -e "${YELLOW}â„¹ï¸  No Ansible files found${NC}"
fi

# Check for sensitive files that should have secrets detection
if has_files_in_dir "ansible" "*.yml" || has_files_in_dir "ansible" "*.yaml" || \
   has_files "*.env*" || has_files "*.secret*" || has_files_in_dir ".github" "*.yml"; then
    
    if check_hook_enabled "detect-secrets"; then
        echo -e "${GREEN}âœ… Sensitive files found - detect-secrets hook is enabled${NC}"
    else
        echo -e "${RED}âŒ Sensitive files found but detect-secrets hook is missing${NC}"
        echo "   Add 'id: detect-secrets' to your .pre-commit-config.yaml"
        EXIT_CODE=1
    fi
else
    echo -e "${YELLOW}â„¹ï¸  No sensitive files requiring secrets detection found${NC}"
fi

# Check that the racktopia/.github repo is being used
if [[ -f "$CONFIG_FILE" ]]; then
    if grep -q "repo: https://github.com/racktopia/.github" "$CONFIG_FILE"; then
        echo -e "${GREEN}âœ… Using racktopia/.github shared hooks${NC}"
        
        # Check if we're in the racktopia/.github repo itself
        if git remote get-url origin 2>/dev/null | grep -q "racktopia/\.github"; then
            # We're in the .github repo - should use 'main' not a specific rev
            current_rev=$(grep -A 1 "repo: https://github.com/racktopia/.github" "$CONFIG_FILE" | grep "rev:" | awk '{print $2}')
            if [[ "$current_rev" != "main" ]]; then
                echo -e "${RED}âŒ racktopia/.github repository should use 'rev: main' to avoid circular dependency${NC}"
                echo "   Current rev: $current_rev"
                echo "   Change to: rev: main"
                EXIT_CODE=1
            else
                echo -e "${GREEN}âœ… Using 'rev: main' for racktopia/.github repo (avoiding circular dependency)${NC}"
            fi
        else
            # We're in a different repo - check if rev is up to date
            current_rev=$(grep -A 1 "repo: https://github.com/racktopia/.github" "$CONFIG_FILE" | grep "rev:" | awk '{print $2}')
            if [[ -n "$current_rev" && "$current_rev" != "main" ]]; then
                # Get latest commit from racktopia/.github main branch
                latest_commit=$(curl -s -f https://api.github.com/repos/racktopia/.github/commits/main 2>/dev/null | grep '"sha"' | head -1 | cut -d'"' -f4 | cut -c1-7 2>/dev/null)
                current_short=$(echo "$current_rev" | cut -c1-7)
                
                if [[ -n "$latest_commit" && "$current_short" != "$latest_commit" ]]; then
                    echo -e "${RED}âŒ racktopia/.github hooks are outdated${NC}"
                    echo "   Current rev: $current_rev ($current_short)"
                    echo "   Latest commit: $latest_commit"
                    echo
                    echo "   Show changes:   git log --oneline ${current_short}..${latest_commit} --no-merges"
                    echo "   Show code diff: git diff ${current_short}..${latest_commit}"
                    echo
                    echo "   Run: pre-commit autoupdate"
                    echo "   Then review changes and commit the updated .pre-commit-config.yaml"
                    EXIT_CODE=1
                elif [[ -n "$latest_commit" && "$current_short" == "$latest_commit" ]]; then
                    echo -e "${GREEN}âœ… racktopia/.github hooks are up to date ($current_short)${NC}"
                else
                    echo -e "${YELLOW}â„¹ï¸  Could not verify latest racktopia/.github version (network issue?)${NC}"
                fi
            else
                echo -e "${YELLOW}â„¹ï¸  Using branch reference instead of commit hash${NC}"
            fi
        fi
    else
        echo -e "${RED}âŒ Not using racktopia/.github shared hooks${NC}"
        echo "   Update your .pre-commit-config.yaml to use 'repo: https://github.com/racktopia/.github'"
        EXIT_CODE=1
    fi
fi

# Summary
echo ""
if [[ $EXIT_CODE -eq 0 ]]; then
    echo -e "${GREEN}ðŸŽ‰ All racktopia standards checks passed!${NC}"
else
    echo -e "${RED}âŒ Some racktopia standards checks failed${NC}"
    echo ""
    echo "Example .pre-commit-config.yaml:"
    echo "---"
    echo "repos:"
    echo "  - repo: https://github.com/racktopia/.github"
    if git remote get-url origin 2>/dev/null | grep -q "racktopia/\.github"; then
        echo "    rev: main              # Use 'main' for racktopia/.github repo itself"
    else
        echo "    rev: main              # Or use specific commit hash (updated via 'pre-commit autoupdate')"
    fi
    echo "    hooks:"
    echo "      - id: racktopia-standards   # Always include this first"
    echo "      - id: markdownlint          # if you have .md files"
    echo "      - id: yamllint              # if you have .yml/.yaml files"
    echo "      - id: ansible-lint          # if you have ansible/ directory"
    echo "      - id: ansible-syntax-check  # if you have ansible/ directory"
    echo "      - id: detect-secrets        # if you have sensitive config files"
fi

exit $EXIT_CODE